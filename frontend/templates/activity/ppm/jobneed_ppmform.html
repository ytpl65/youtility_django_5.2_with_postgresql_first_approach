{% extends "globals/base_form.html" %}

<!---- BEGIN PAGE TITLE ------>
{% block page_title %}
PPM Form
{% endblock page_title %}
<!----- END PAGE TITLE -------->

1{% block extra_css %}
{{ ppmjobneedform.media.css }}
<link  href="{{ static('assets/plugins/custom/DataTables/datatables.min.css') }}" rel="stylesheet" type="text/css"/>
<link  href="{{ static('assets/plugins/custom/Editor-2.0.8/css/editor.dataTables.min.css') }}" rel="stylesheet" type="text/css"/>
{% endblock extra_css %}

<!-------------------------- BEGIN PAGE BREADCUMB ----------------------->
{% block pagebreadcumb %}
<!--will call parent contents -->
{{ super() }}
<li class="breadcrumb-item pe-3"><a href="{{ url('activity:ppmjobneed') }}?template=true" class="pe-3">PPM List</a></li>
<li class="breadcrumb-item pe-3"><a href="javascript:void(0)" class="pe-3">PPM</a></li>
{% endblock pagebreadcumb %}
<!-------------------------- END PAGE BREADCUMB ------------------------->

<!------ BEGIN FORM TITLE ------->
{% block form_title %}
Task Form
{% endblock form_title %}
<!------ END FORM TITLE -------->


<!--------- BEGIN NON FIELD ERRORS -------->
{% block nonfield_errors %}
{% if ppmjobneedform.non_field_errors() %}
<div id="non_field_error" class="alert alert-danger" style="width: 73%;">
    {% for error in ppmjobneedform.non_field_errors()[::-1] %}
    <strong>Error</strong> <span>{{ error }}</span>
    {% endfor %}
    <button type="button" class="btn-close flt-right" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}
{% endblock nonfield_errors %}
<!---------- END NON FIELD ERRORS --------->


{% block form %}
<form action="">
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
    <input type="hidden" name="{{ ppmjobneedform.ctzoffset.name }}" id = "{{ ppmjobneedform.ctzoffset.auto_id }}" value="-1">
    
    <div class="row gy-3">
        <div class="col-md-6">
            <div class="input-group mb-3">
                <div class="col-md-4">
                    {{ ppmjobneedform.jobdesc.label_tag() }}
                </div>
                <div class="col-md-8">
                    {{ ppmjobneedform.jobdesc }}
                </div>
            </div>
            <div class="input-group mb-3">
                <div class="col-md-4">
                    {{ ppmjobneedform.asset.label_tag() }}
                </div>
                <div class="col-md-8">
                    {{ ppmjobneedform.asset }}
                </div>
            </div>
            <div class="input-group mb-3">
                <div class="col-md-4">
                    {{ ppmjobneedform.qset.label_tag() }}
                </div>
                <div class="col-md-8">
                    {{ ppmjobneedform.qset }}
                </div>
            </div>
            <div class="input-group mb-6">
                <div class="col-md-4">
                    <label class="required">Assign to:</label>
                </div>
                <div class="col-md-8">
                    <div class="form-check form-check-inline">
                        <input type="radio" class="form-check-input" name={{ ppmjobneedform.assign_to.name }}
                            id="{{ ppmjobneedform.assign_to.auto_id }}1" value="PEOPLE" checked
                            onchange="showHideSelectField('PEOPLE')">
                        <label class="form-check-label" for="{{ ppmjobneedform.assign_to.auto_id }}">People</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input type="radio" class="form-check-input" name={{ ppmjobneedform.assign_to.name }}
                            id="{{ ppmjobneedform.assign_to.auto_id }}2" value="GROUP" onchange="showHideSelectField('GROUP')">
                        <label class="form-check-label" for="{{ ppmjobneedform.assign_to.auto_id }}">Group</label>
                    </div>
                </div>
            </div>

            <div class="input-group mb-3">
                <div class="col-md-4">
                    {{ ppmjobneedform.people.label_tag() }}
                </div>
                <div class="col-md-8">
                    {{ ppmjobneedform.people }}
                </div>
            </div>
            <div class="input-group mb-3">
                <div class="col-md-4">
                    {{ ppmjobneedform.priority.label_tag() }}
                </div>
                <div class="col-md-8">
                    {{ ppmjobneedform.priority }}
                </div>
            </div>
            <div class="input-group mb-3">
                <div class="col-md-4">
                    {{ ppmjobneedform.jobstatus.label_tag() }}
                </div>
                <div class="col-md-8">
                    {{ ppmjobneedform.jobstatus }}
                </div>
            </div>
            <div class="input-group mb-3">
                <div class="col-md-4">
                    {{ ppmjobneedform.scantype.label_tag() }}
                </div>
                <div class="col-md-8">
                    {{ ppmjobneedform.scantype }}
                </div>
            </div>
            
        </div>
        <div class="col-md-6">
            <div class="input-group mb-3">
                <div class="col-md-4">
                    {{ ppmjobneedform.plandatetime.label_tag() }}
                </div>
                <div class="col-md-8">
                    {{ ppmjobneedform.plandatetime }}
                </div>
            </div>
            <div class="input-group mb-3">
                <div class="col-md-4">
                    {{ ppmjobneedform.expirydatetime.label_tag() }}
                </div>
                <div class="col-md-8">
                    {{ ppmjobneedform.expirydatetime }}
                </div>
            </div>
            <div class="input-group mb-3">
                <div class="col-md-4">
                    {{ ppmjobneedform.gracetime.label_tag() }}
                </div>
                <div class="col-md-8">
                    {{ ppmjobneedform.gracetime }}
                </div>
            </div>
            <div class="input-group mb-3">
                <div class="col-md-4">
                    {{ ppmjobneedform.starttime.label_tag() }}
                </div>
                <div class="col-md-8">
                    {{ ppmjobneedform.starttime }}
                </div>
            </div>
            <div class="input-group mb-3">
                <div class="col-md-4">
                    {{ ppmjobneedform.endtime.label_tag() }}
                </div>
                <div class="col-md-8">
                    {{ ppmjobneedform.endtime }}
                </div>
            </div>
            <div class="input-group mb-3">
                <div class="col-md-4">
                    {{ ppmjobneedform.performedby.label_tag() }}
                </div>
                <div class="col-md-8">
                    {{ ppmjobneedform.performedby }}
                </div>
            </div>
            <div class="input-group mb-3">
                <div class="col-md-4">
                    {{ ppmjobneedform.ticketcategory.label_tag() }}
                </div>
                <div class="col-md-8">
                    {{ ppmjobneedform.ticketcategory }}
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock form %}


{% block popup_alerts %}
    {% call general_popup(title='Attachment Details <i class="fas text-white fa-paperclip ch4"></i>', popup_id="id_attachmentdetails", modal_size='modal-xl') %}
        <div class="modal-body">
            <table class="display cell-border" style="width:100%" id="tabAttachmentDetails"></table>
        </div>
        
    {% endcall  %}

    {{ mainattachment() }}
{% endblock popup_alerts %}

{% block extras %}
<br>
<div class="row">
    <div class="card">
        <div class="card-header ps-0 mb-0">
            <h4 class="ch4">Task Details&nbsp;<i class="fas text-white fa-layer-group ch4"></i></h4>
        </div>
        <div class="card-body pt-0">
            <table id="task_details" class="display cell-border compact hover nowrap"></table>
        </div>
    </div>

</div>
{% endblock extras %}

{% block breadcumbactions %}
<button class="btn btn-secondary dropdown-toggle" type="button" id="id_actions" data-bs-toggle="dropdown" aria-expanded="false">
    Actions
</button>
<ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
    <li><a class="dropdown-item" href="#" id="id_attachment"><i class="fas text-white fa-paperclip"></i> &nbsp;Attachment</a></li>
</ul>
{% endblock breadcumbactions %}


{% block extra_scripts %}
<script src="{{ static('assets/plugins/custom/DataTables/datatables.min.js') }}" type="text/javascript"></script>
<script src="{{ static('assets/plugins/custom/DataTables/Select-1.3.4/js/dataTables.select.min.js') }}" type="text/javascript"></script>
{{ ppmjobneedform.media.js }}

<script>
    //set the variables which are gonna used in attachment.js file for fetching attachments against the owner
    var attachmentParams = {
        attachmentUrl  : '{{ url("activity:attachments") }}',
        attachmentOwner: '{{ ppmjobneedform.instance.uuid }}',
        csrf           : '{{ csrf_token }}',
        ownername      : "Jobneed",
        folderType     : 'ppm',
        media_url      : '{{ MEDIA_URL }}',
        peopleid       : "{{ request.user.id }}"
    }

</script>
<script src="{{ static('assets/js/local/attachment.js') }}" type="text/javascript"></script>
<script>
    var table;
    var ajaxData = {};
    var taskid = {{ ppmjobneedform.instance.id }}
    var attachmentDetails;
    
    function showHideSelectField(val) {
        if (val == "PEOPLE") {
            //$("#aatopdiv").show();
            $(".people").show();
            $(".pgroup").hide();
        }else {
            //$("#aatopdiv").hide();
            $(".pgroup").show();
            $(".people").hide();
        }
    }

    function showAttachmentDetails(id, from){
        $('#id_attachmentdetails').modal('show')
        ajaxData.id=id
        ajaxData.action = from === 'jobneed' ? 'getAttachmentJobneed' : 'getAttachmentJND' 
        attachmentDetails.ajax.reload()
    }

    $(document).ready(() => {
        makeReadonlyFields()
        
        //assignto toggle
        if ('{{ ppmjobneedform.instance.id }}' == ('None' || "")) {
            showHideSelectField('PEOPLE')
        }else{
            var assignto = '{{ ppmjobneedform.instance.people }}' == ('None' || "") ? "GROUP" : "PEOPLE"
            showHideSelectField(assignto)
        }
        //set ctzoffset
  	    $("#id_ctzoffset").val(-new Date().getTimezoneOffset())

        //datetime widget configurations
        $("#id_plandatetime, #id_expirydatetime").flatpickr({
            enableTime: true,
            time_24hr: true,
            dateFormat: 'd-M-Y H:S'
        })

        table = $("#task_details").DataTable({
            ajax:{
                url:`{{ url('activity:ppmjobneed') }}?action=get_ppmtask_details&taskid=${taskid}`
            },
            columns:[
                {data:'id', visible:false},
                {data:'question__quesname', title:'Question'},
                {data:'answertype', title:'Type'},
                {data:'min', title:'Min'},
                {data:'max', title:'Max'},
                {data:'options', title:'Options'},
                {data:'alerton', title:'Alert On'},
                {data:'answer', title:'Answer'},
                {data:'ismandatory', title:'Mandatory'},
                {data: null, title:'Attachments', render:function(data, type, row, meta){
                    return `<a href="javascript:void(0)"  onClick='showAttachmentDetails(${row['id']}, "jnd")'>View</a>`
                }
                }
            ],
            ordering:false,
            deferRender: true,
            scrollX: true,
            dom: `<'row' <'col-sm-6 d-flex justify-content-start'f> <'col-sm-6 d-flex justify-content-end'B> >rt<'row'
            <'col-sm-6'l> <'col-sm-6'p><'col-sm-12 d-flex justify-content-center'i>>`,
            buttons:[],
        })

        $('#id_attachmentdetails').on('shown.bs.modal', function (event) {
            $.fn.dataTable.tables( {visible: true, api: true} ).columns.adjust();
                $('#id_attachmentdetails').modal({
                    keyboard: false
                })
                attachmentDetails = $("#tabAttachmentDetails").DataTable(
                {
                    ajax:{
                        url:`{{ url("schedhuler:jobneedtasks") }}`,
                        data:function(d){
                        return  $.extend(d, ajaxData);
                        }
                    },
                    retrieve: true,
                    columns:[
                        { data: "id", visible: false },
                        { title:'SL No.', width:"5%", data:null, defaultContent:null, render:function (data, type, row, meta) { return meta.row  + 1; }},
                        { data: "filepath",  width:"5%", title:'File', render:function (data, type, row, meta) { return `<img src="{{ MEDIA_URL }}${row.filepath.replace('youtility4_media/', "")}/${row.filename}" class="card-img-top" target="_blank" alt="" style="width: 30px;height: 30px;">`; }},
                        { data: "filename",  title:'File Name' },
                        { data: null, width:"5%", defaultContent:null, title:"Action", render:function(data, type, row, meta ){
                        let file = `{{ MEDIA_URL }}${row.filepath.replace('youtility4_media/', "")}/${row.filename}`
                        return `<a href="${file}" target="_blank" class=""><i class="ch4 fas fa-eye"></i></a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="${file}" download="${row.filename}"><i class="ch4 fas fa-save"></i></a>`;
                        } },
                    ],
                    ordering:false,
                    deferRender: true,
                    scrollX: true,
                    dom: `<'row' <'col-sm-6 d-flex justify-content-start'f> <'col-sm-6 d-flex justify-content-end'B> >rt<'row'
                    <'col-sm-6'l> <'col-sm-6'p><'col-sm-12 d-flex justify-content-center'i>>`,
                    buttons:[],
                }
            )
        })
    })

</script>

{% endblock extra_scripts %}